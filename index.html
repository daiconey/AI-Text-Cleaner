import React, { useState, useEffect, useRef } from 'react';
import { Copy, Trash2, ArrowRight, Check, Sparkles, Settings2, Eraser, FileText } from 'lucide-react';

export default function App() {
  const [inputText, setInputText] = useState('');
  const [outputText, setOutputText] = useState('');
  const [copied, setCopied] = useState(false);
  
  // Settings state
  const [settings, setSettings] = useState({
    removeMarkdown: true,    // * # _ ` etc.
    removeCitations: true,   // [1], (1), +1, [1].[2]
    trimLeadingSpace: true,  // Remove space at start of lines
    removeTrailingNumbers: true, // Remove isolated numbers at end of sentences
    fixPunctuation: true,    // Fix duplicate punctuation or spaces
  });

  // Dirty sample text for testing
  const SAMPLE_TEXT = ` ## 生成AIによる業務効率化について

 **近年**のAI技術は飛躍的に進化しており、ビジネスシーンでも多用されています。[1]
  特に大規模言語モデル（LLM）の登場は革命的です。+1

 * 議事録の作成
 * アイデア出し
 * プログラミング補助 [2].[3]

しかし、AIが出力する文章には**不要な記号**や、文法的に不自然なスペースが含まれることがあります。(4), (5)
また、Deep Researchのような検索を行うと、文末に引用数字が残ることがあります 12

 結論として、出力後の「整形作業」が重要になります。+5 +6
ぜひこのツールを使って、快適なコピペ生活を送ってください 1
`;

  // Main cleaning logic
  useEffect(() => {
    let text = inputText;

    if (!text) {
      setOutputText('');
      return;
    }

    // 1. Remove Markdown (*, #, _, `, > at start)
    if (settings.removeMarkdown) {
      // Remove bold/italic markers (* or _)
      text = text.replace(/(\*\*|__)(.*?)\1/g, '$2'); // Bold
      text = text.replace(/(\*|_)(.*?)\1/g, '$2');    // Italic
      
      // Remove headers (#)
      text = text.replace(/^#+\s*/gm, ''); 
      
      // Remove list markers at start of line (*, -, +) if desired, 
      // but usually people want to keep the list structure, just not the formatting.
      // Cleaning standalone chars:
      text = text.replace(/\*\*/g, ''); 
      text = text.replace(/##/g, ''); 
      // If user wants to strip ALL *, # symbols even inside text:
      text = text.replace(/[*#`]/g, ''); 
    }

    // 2. Remove Citations and Reference Numbers (+1, [1], (1))
    if (settings.removeCitations) {
      // Improved logic: Handle sequential citations like [1][2], [1],[2], [1].[2]
      // Matches bracketed numbers followed optionally by separators (space, dot, comma) and more bracketed numbers
      // This ensures "[1].[2]" is removed entirely, not leaving a "." behind.
      const bracketPattern = /([\[\(【]\d+[\]\)】])([\s,.]*[\[\(【]\d+[\]\)】])*/g;
      text = text.replace(bracketPattern, '');
      
      // Deep Research style "+1", handling sequences like "+1 +2"
      text = text.replace(/(\+\d+)([\s,]*\+\d+)*/g, '');
    }

    // 2.5 Remove Trailing Numbers (Independent logic)
    if (settings.removeTrailingNumbers) {
       // Case 1: Remove space-separated numbers at end of line (e.g., "word 1 2")
       // Also handles full-width spaces just in case
       text = text.replace(/([\s\u3000]+\d+)+[\s\u3000]*$/gm, '');

       // Case 2: Remove numbers attached directly to punctuation at end of line (e.g., "word。12")
       text = text.replace(/([。、．\.!?])\d+([\s\u3000]+\d+)*[\s\u3000]*$/gm, '$1');
    }

    // 3. Trim Leading/Trailing Spaces per line
    if (settings.trimLeadingSpace) {
      text = text.split('\n').map(line => line.trimStart()).join('\n');
    }

    // 4. General Cleanup (Multiple spaces, weird empty lines if needed)
    if (settings.fixPunctuation) {
       // Consolidate multiple spaces into one (except newlines)
       // text = text.replace(/[ \t]+/g, ' '); 
       // Note: Careful not to break indentation if lists exist, but user wants clean text.
    }

    setOutputText(text);
    setCopied(false);
  }, [inputText, settings]);

  const handleCopy = () => {
    if (!outputText) return;
    const textArea = document.createElement("textarea");
    textArea.value = outputText;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand("copy");
    document.body.removeChild(textArea);
    
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const handleClear = () => {
    setInputText('');
    setCopied(false);
  };

  const handleInsertSample = () => {
    setInputText(SAMPLE_TEXT);
  };

  const toggleSetting = (key) => {
    setSettings(prev => ({ ...prev, [key]: !prev[key] }));
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans flex flex-col">
      {/* Header */}
      <header className="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between shadow-sm sticky top-0 z-10">
        <div className="flex items-center gap-2">
          <div className="bg-blue-600 p-2 rounded-lg text-white">
            <Sparkles size={20} />
          </div>
          <h1 className="text-xl font-bold bg-gradient-to-r from-blue-700 to-blue-500 bg-clip-text text-transparent">
            AI Text Cleaner
          </h1>
        </div>
        <div className="text-sm text-slate-500 hidden sm:block">
          生成AIのテキストを瞬時に整形
        </div>
      </header>

      <main className="flex-1 max-w-7xl mx-auto w-full p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-80px)]">
        
        {/* Input Column */}
        <div className="flex flex-col gap-3 h-full">
          <div className="flex items-center justify-between">
            <label className="font-semibold text-slate-700 flex items-center gap-2">
              <span className="bg-slate-200 text-slate-600 px-2 py-0.5 rounded text-xs">INPUT</span>
              元の文章
            </label>
            <div className="flex gap-2">
              <button 
                onClick={handleInsertSample}
                className="text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-blue-50"
                title="整形前のサンプル文を入力します"
              >
                <FileText size={14} />
                サンプル
              </button>
              <button 
                onClick={handleClear}
                className="text-slate-400 hover:text-red-500 text-sm flex items-center gap-1 transition-colors px-2 py-1 rounded hover:bg-slate-100"
              >
                <Trash2 size={14} />
                クリア
              </button>
            </div>
          </div>
          <textarea
            className="flex-1 w-full p-4 rounded-xl border border-slate-200 shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none font-mono text-sm leading-relaxed bg-white"
            placeholder="ここにChatGPTやClaude、Perplexityなどの生成テキストを貼り付けてください..."
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
          />
        </div>

        {/* Controls & Output Column */}
        <div className="flex flex-col gap-3 h-full">
          {/* Toolbar / Settings */}
          <div className="bg-white rounded-xl border border-slate-200 p-3 shadow-sm">
             <div className="flex items-center gap-2 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">
               <Settings2 size={12} />
               整形オプション
             </div>
             <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
               <Toggle label="Markdown記号削除 (*, #)" active={settings.removeMarkdown} onClick={() => toggleSetting('removeMarkdown')} />
               <Toggle label="注釈・引用削除 ([1], +1)" active={settings.removeCitations} onClick={() => toggleSetting('removeCitations')} />
               <Toggle label="文頭スペース削除" active={settings.trimLeadingSpace} onClick={() => toggleSetting('trimLeadingSpace')} />
               <Toggle label="文末のゴミ数字削除" active={settings.removeTrailingNumbers} onClick={() => toggleSetting('removeTrailingNumbers')} />
             </div>
          </div>

          <div className="flex items-center justify-between">
            <label className="font-semibold text-blue-700 flex items-center gap-2">
              <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-xs">OUTPUT</span>
              整形後の文章
            </label>
            <div className="flex gap-2">
              <button
                onClick={handleCopy}
                disabled={!outputText}
                className={`
                  flex items-center gap-2 px-4 py-1.5 rounded-lg text-sm font-medium transition-all
                  ${copied 
                    ? 'bg-green-500 text-white shadow-green-200 shadow-lg scale-105' 
                    : 'bg-blue-600 text-white hover:bg-blue-700 shadow-blue-200 shadow-md hover:shadow-lg'
                  }
                  disabled:opacity-50 disabled:cursor-not-allowed
                `}
              >
                {copied ? <Check size={16} /> : <Copy size={16} />}
                {copied ? 'コピーしました！' : 'コピーする'}
              </button>
            </div>
          </div>
          
          <div className="relative flex-1">
            <textarea
              readOnly
              className="w-full h-full p-4 rounded-xl border border-blue-200 bg-blue-50/30 text-slate-800 shadow-inner focus:ring-2 focus:ring-blue-500 outline-none resize-none font-mono text-sm leading-relaxed"
              placeholder="整形された文章がここに表示されます"
              value={outputText}
            />
             {!inputText && (
              <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-30">
                <div className="text-center">
                  <Eraser size={48} className="mx-auto text-slate-400 mb-2" />
                  <p className="text-slate-500 text-sm">左側にテキストを入力してください</p>
                </div>
              </div>
            )}
          </div>
        </div>

      </main>
    </div>
  );
}

function Toggle({ label, active, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`
        flex items-center gap-2 px-3 py-2 rounded-lg text-xs font-medium transition-all border text-left
        ${active 
          ? 'bg-blue-50 border-blue-200 text-blue-700' 
          : 'bg-slate-50 border-slate-200 text-slate-500 hover:bg-slate-100'
        }
      `}
    >
      <div className={`w-3 h-3 rounded-full border flex items-center justify-center flex-shrink-0 ${active ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
        {active && <Check size={8} className="text-white" />}
      </div>
      {label}
    </button>
  );
}
